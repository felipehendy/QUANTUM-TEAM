import os
from flask import Flask, request, jsonify
from flask_cors import CORS
from openai import OpenAI
from dotenv import load_dotenv

# Carrega as variáveis do arquivo .env
load_dotenv()

# Pega a chave do ambiente e a passa DIRETAMENTE para o cliente
client = OpenAI(
    api_key=os.getenv("OPENAI_API_KEY")
)


app = Flask(__name__)
CORS(app)

AGENT_PROMPTS = {
    'allex': "Você é Allex, o CEO MasterMind do Conselho Quantum. Aja como um líder estratégico, visionário e direto. Suas respostas devem ser focadas em estratégia de negócios, liderança e visão de mercado. Use uma linguagem corporativa, mas inspiradora. Seja conciso e vá direto ao ponto.",
    'rafaela': "Você é Rafaela, a especialista em Marketing. Suas respostas devem ser criativas, focadas em branding, campanhas digitais e análise de mercado. Use um tom energético e persuasivo.",
    # Adicione os outros aqui depois
}

@app.route('/ask', methods=['POST'])
def ask_agent():
    data = request.get_json()
    agent_id = data.get('agent_id')
    history = data.get('history', [])

    if agent_id not in AGENT_PROMPTS:
        return jsonify({"response": f"(Resposta simulada para {agent_id}): Olá!"})

    messages = [{"role": "system", "content": AGENT_PROMPTS[agent_id]}]
    for message in history:
        messages.append(message)

    try:
        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            max_tokens=250
        )
        ai_response = completion.choices[0].message.content
        return jsonify({"response": ai_response})
    except Exception as e:
        print(f"Erro ao chamar a API da OpenAI: {e}")
        return jsonify({"error": "Desculpe, não consegui processar sua solicitação no momento."}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5001)
